---
const sitekey = "50b2fe65-b00b-4b9e-ad62-3ba471098be2";
const lang = Astro.url.pathname.startsWith("/cy") ? "cy" : "en";
const theme = "dark";
---

<div id="captcha-container">
  <div id="hcaptcha" class="mb-6"></div>
  <p id="captcha-error" class="text-red-600 text-sm hidden" role="alert">Please complete the captcha before submitting.</p>
</div>

<script type="module">
    const sitekey = "50b2fe65-b00b-4b9e-ad62-3ba471098be2";
    const theme = getCurrentTheme();
    const themeToggle = document.querySelector('[data-theme-switcher]');
    let currentCaptchaId = null;

    function getCurrentTheme() {
        return localStorage.getItem("theme") === "light" ? "light" : "dark";
    }

    function loadScriptForLangAndTheme(lang, theme) {
        console.log("🌍 loadScriptForLangAndTheme with lang:", lang, "and theme:", theme);

        // Remove old script
        const oldScript = document.querySelector('script[src^="https://js.hcaptcha.com/1/api.js"]');
        if (oldScript) {
            oldScript.remove();
            console.log("🧹 Removed old hCaptcha script.");
        }

        // Remove old hCaptcha from memory
        if (window.hcaptcha) {
            delete window.hcaptcha;
            currentCaptchaId = null
            console.log("🧼 Removed cached hCaptcha object.");
        }

        // Replace hCaptcha div
        const container = document.getElementById("captcha-container");
        const oldCaptcha = document.getElementById("hcaptcha");
        if (oldCaptcha) oldCaptcha.remove();
        console.log("🧹 Removed old hCaptcha div.");

        const newCaptcha = document.createElement("div");
        newCaptcha.id = "hcaptcha";
        newCaptcha.className = "mb-6";
        container.appendChild(newCaptcha);
        console.log("📦 Appended new hCaptcha div:", newCaptcha);

        // Define global onload callback
        window.hcaptchaOnLoad = () => {

            const captchaDiv = document.getElementById("hcaptcha");
            if (!captchaDiv) {
                console.warn("🚫 hcaptcha div not found on load.");
                return;
            }
            if (currentCaptchaId !== null) {
                console.log("🔁 hCaptcha already rendered, skipping.");
                return;
            }
            if (window.hcaptcha) {
            console.log("✅ hCaptcha loaded, now rendering.");
            currentCaptchaId = window.hcaptcha.render(newCaptcha, {
                sitekey,
                theme: theme,
                language: lang, // you can also use `hl`, but this is more explicit
            });
            } else {
                console.log("❌ hCaptcha not ready during hcaptchaOnLoad.");
            }
        };

        // Add the new script with explicit render and onload callback
        const script = document.createElement("script");
        script.src = `https://js.hcaptcha.com/1/api.js?render=explicit&recaptchacompat=off&onload=hcaptchaOnLoad&hl=${lang}`;
        script.async = true;
        script.defer = true;
        document.body.appendChild(script);
        console.log("📦 Appended hCaptcha script for lang:", lang);
    }

    // Initial render
    const container = document.getElementById("hcaptcha");
    if (container) {
        const lang = location.pathname.startsWith("/cy") ? "cy" : "en";
        loadScriptForLangAndTheme(lang, theme);
    }

    bindThemeToggleListener();

    document.addEventListener("astro:after-swap", () => {
        const container = document.getElementById("hcaptcha");
        if (!container) {
            console.log("🚫 Not on contact page. Skipping hCaptcha.");
            return;
        }
        const lang = location.pathname.startsWith("/cy") ? "cy" : "en";
        const theme = getCurrentTheme();
        loadScriptForLangAndTheme(lang, theme);
        bindThemeToggleListener();
    });

    function bindThemeToggleListener() {
        const themeToggle = document.querySelector('[data-theme-switcher]');
        if (themeToggle) {
            console.log("🔗 Binding theme toggle listener.");
            themeToggle.addEventListener("change", () => {
                const container = document.getElementById("hcaptcha");
                if (!container) {
                    console.log("🚫 theme-change received, but hcaptcha not found.");
                    return;
                }

                const lang = location.pathname.startsWith("/cy") ? "cy" : "en";
                const theme = document.documentElement.classList.contains("dark") ? "dark" : "light";

                console.log("🎨 Theme changed – reloading HCaptcha", theme);
                loadScriptForLangAndTheme(lang, theme);
            });
        } else {
            console.log("❌ Theme toggle not found.");
        }
    }

    const form = document.getElementById("site-contact-form");

    form?.addEventListener("submit", function (e) {
        let isValid = true;

        // Validate hCaptcha
        const captchaResponse = form.querySelector('textarea[name="h-captcha-response"]').value;
        const captchaError = document.getElementById("captcha-error");

        if (!captchaResponse) {
            e.preventDefault();
            captchaError?.classList.remove("hidden");
            document.getElementById("hcaptcha")?.scrollIntoView({ behavior: "smooth", block: "center" });
            isValid = false;
        } else {
            captchaError?.classList.add("hidden");
        }

        // Validate required fields
        const fields = [
            { name: "name", message: "Please enter your name." },
            { name: "email", message: "Please enter a valid email address." },
            { name: "message", message: "Please enter your message." }
        ];

        fields.forEach(({ name, message }) => {
            const input = form.querySelector(`[name="${name}"]`);
            const errorEl = document.getElementById(`error-${name}`);
            const value = input?.value.trim();

            if (!value) {
                e.preventDefault();
                isValid = false;
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove("hidden");
                }
            } else {
                if (errorEl) errorEl.classList.add("hidden");
            }
        });

        // Optionally scroll to first error
        if (!isValid) {
            const firstError = form.querySelector("p[role=alert]:not(.hidden)");
            firstError?.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        if (name === "email" && value && !isValidEmail(value)) {
            e.preventDefault();
            isValid = false;
            if (errorEl) {
                errorEl.textContent = "Please enter a valid email address.";
                errorEl.classList.remove("hidden");
            }
        }
    });
</script>